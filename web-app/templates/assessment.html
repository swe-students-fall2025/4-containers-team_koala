{% extends 'base.html' %}

{% block title %}Assessment - Lesson {{ lesson_num }}{% endblock %}

{% block content %}
<h1>Assessment for Lesson {{ lesson_num }}</h1>
<p>{{ lesson.description }}</p>

<h2>Tasks</h2>
<ul>
    {% for task in tasks %}
        <li>
            <strong>{{ task.prompt }}</strong><br>
            Target: {{ task.target_sign }}
            | Repetitions required: {{ task.min_repetitions }}
            | Min confidence: {{ task.min_confidence }}
        </li>
    {% endfor %}
</ul>

<hr>

<h2>Live Assessment</h2>

<div class="webcam-section" style="position:relative; width:640px; height:480px;">
    <video
        id="video"
        autoplay
        playsinline
        width="640"
        height="480"
        style="background:#000;border:1px solid #ccc;"
    ></video>

    <canvas
        id="overlay"
        width="640"
        height="480"
        style="position:absolute;top:0;left:0;pointer-events:none;"
    ></canvas>
</div>

<div class="prediction-panel">
    <p>Predicted letter: <span id="letter-display">-</span></p>
    <p>Confidence: <span id="confidence-display">0.00</span></p>
</div>

<h3>Task Status</h3>
<div id="task-status"></div>

<p id="assessment-result" style="font-size:1.2em;font-weight:bold;"></p>

<a href="{{ url_for('training.lesson', num=lesson_num) }}" class="btn-back">‚Üê Back to lesson</a>

<!-- Load MediaPipe scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<!-- Webcam + detection -->
<script type="module" src="{{ url_for('static', filename='js/webcam.js') }}"></script>

<!-- Grading hook: send predictions to backend -->
<script type="module">
document.addEventListener("DOMContentLoaded", () => {
    const POST_URL = "{{ url_for('training.assessment', num=lesson_num) }}";
    const taskStatusDiv = document.getElementById("task-status");
    const assessmentResult = document.getElementById("assessment-result");

    // Live grading hook
    window.onPrediction = function(letter, confidence, landmarks) {
        if (!landmarks || landmarks.length === 0) return;

        fetch(POST_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ points: landmarks })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.task_results) return;

            // Update task status
            taskStatusDiv.innerHTML = data.task_results.map(t => `
                <p>
                    <strong>${t.prompt}</strong><br>
                    Matched: ${t.matched_count}
                    | Required: ${t.min_repetitions}
                    | Status: <span style="color:${t.passed ? 'green' : 'red'}">
                        ${t.passed ? 'Passed' : 'Not yet'}
                    </span>
                </p>
            `).join("");

            // Show overall assessment result
            if (data.overall_pass) {
                assessmentResult.textContent = "üéâ Assessment Passed! Redirecting to Dashboard...";
                assessmentResult.style.color = "green";

                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = "{{ url_for('dashboard.home') }}";
                }, 2000);
            }
        })
        .catch(err => console.error("Grading error:", err));
    };
});
</script>
{% endblock %}
